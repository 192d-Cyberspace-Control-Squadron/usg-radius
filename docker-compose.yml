services:
  radius:
    build: .
    container_name: usg-radius
    restart: unless-stopped

    # Network mode - use host for easier RADIUS client access
    # Alternative: bridge mode with port mapping (see commented section)
    network_mode: host

    # Uncomment for bridge networking:
    # ports:
    #   - "1812:1812/udp"  # RADIUS Authentication
    #   - "1813:1813/udp"  # RADIUS Accounting (future)

    volumes:
      # Mount configuration (read-only)
      - ./examples/configs/docker.json:/etc/radius/config.json:ro

      # Mount audit logs (persistent)
      - radius-logs:/var/log/radius

    environment:
      # Core secrets
      - RADIUS_SECRET=${RADIUS_SECRET:?RADIUS_SECRET must be set}

      # Client configuration
      - CLIENT_1_NETWORK=${CLIENT_1_NETWORK:-192.168.1.0/24}
      - CLIENT_1_SECRET=${CLIENT_1_SECRET:?CLIENT_1_SECRET must be set}
      - CLIENT_1_NAME=${CLIENT_1_NAME:-Client Network 1}

      - CLIENT_2_NETWORK=${CLIENT_2_NETWORK:-10.0.0.0/8}
      - CLIENT_2_SECRET=${CLIENT_2_SECRET:?CLIENT_2_SECRET must be set}
      - CLIENT_2_NAME=${CLIENT_2_NAME:-Client Network 2}

      # Admin user
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?ADMIN_PASSWORD must be set}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RUST_LOG=${RUST_LOG:-info}

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

    # Health check
    healthcheck:
      test: ["CMD", "/usr/local/bin/usg_radius", "--version"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  radius-logs:
    driver: local
