global
    log stdout local0
    maxconn 4096
    tune.bufsize 32768

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    retries 3

# RADIUS Authentication (UDP)
frontend radius_auth
    bind *:1812
    mode udp
    default_backend radius_servers_udp

backend radius_servers_udp
    mode udp
    balance roundrobin
    # Service discovery via Docker DNS
    server-template radius-server 10 radius-server:1812 check resolvers docker resolve-prefer ipv4
    server radius1 radius-server-1:1812 check inter 10s rise 2 fall 3
    server radius2 radius-server-2:1812 check inter 10s rise 2 fall 3
    server radius3 radius-server-3:1812 check inter 10s rise 2 fall 3

# HAProxy Statistics
frontend stats
    bind *:8080
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# Health Check Proxy (HTTP)
frontend health_proxy
    bind *:8081
    mode http
    default_backend radius_health_servers

backend radius_health_servers
    mode http
    balance roundrobin
    option httpchk GET /health/ready
    http-check expect status 200
    server radius1 radius-server-1:2812 check
    server radius2 radius-server-2:2812 check
    server radius3 radius-server-3:2812 check

# Docker DNS resolver
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold valid 10s
